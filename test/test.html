<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Testing page</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ccxt@1.17.229/build/ccxt.browser.js"></script>
  <script src="../dist/ta-math.iife.js"></script>
</head>
<body>

<!-- Plotly chart will be drawn inside this div -->
<div id="plotly-div" style="width: 800px; height: 500px;"></div>

<script>
var fetchFromExchange = new ccxt.binance({'proxy': 'https://cors-anywhere.herokuapp.com/'}).fetchOHLCV ('BTC/USDT', '1d', Date.now() - 1000*60*60*24*30*5);

fetchFromExchange.then( function(ohlcv) {
  render(new TA(ohlcv));
}).catch( function(err) {
  Plotly.d3.csv("https://raw.githubusercontent.com/munrocket/ta-math/master/test/data.csv", function (err, rows) {
    window.alert("CORS/Binance server not answer. CSV data will be used")
    function unpack(rows, columns) {
      return rows.map(function (row) {
        return columns.reduce(function(result, column) {
          result.push(parseFloat(row[column]));
          return result;
        }, []);
      });
    };
    var ohlcv = unpack(rows, ['time', 'open', 'high', 'low', 'close', 'volume']);
    render(new TA(ohlcv));
  });
});

function render(ta) {
  var charts = [
    { context: barContext(ta), label: "None" },
    { context: maContext(ta), label: "Simple Moving Average" },
    { context: maContext(ta, true), label: "Exponential Moving Average" },
    { context: bbContext(ta), label: "Bollinger Bands" },
    { context: bbContext(ta, true), label: "Exponential Bollinger Bands" },
  ];
  var data = charts.reduce((all, ch) => all.concat(ch.context), []);

  function visibleChart(ch, charts) {
    result = [true];
    for (let i = 1; i < charts.length; i++) {
      for (let j = 0; j < charts[i].context.length; j++) {
        result.push(ch == charts[i]);
      }
    }
    return result;
  }

  var layout = {
    margin: { r: 5, t: 5, b: 50, l: 5 }, 
    xaxis: { autorange: true, type: 'date' }, 
    yaxis: { autorange: true, type: 'linear' },
    showlegend: true,
    dragmode: 'zoom',
    hovermode: 'closest',
    legend: { x: 0.3, y: 1.1, "orientation": "h" },
    updatemenus: [{
      x: 0,
      y: 1,
      xanchor: "left",
      yanchor: "bottom",
      buttons: charts.reduce((all, ch) => {all.push(
        { method: 'restyle',
          args: ['visible', visibleChart(ch, charts)],
          label: ch.label
        })
      return all}, [])
    }]
  };
  var defaultPlotlyConfiguration = {
    modeBarButtonsToRemove: ['sendDataToCloud', 'autoScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian', 'lasso2d', 'select2d'],
    displaylogo: false,
    showTips: true
  };

  Plotly.plot('plotly-div', data, layout, defaultPlotlyConfiguration);
}

function barContext(ta) {
  return [{
    name: 'BTC/USDT',
    x: ta.$time, 
    close: ta.$close, 
    high: ta.$high, 
    low: ta.$low, 
    open: ta.$open, 
    type: 'candlestick', 
    decreasing: {line: {color: '#9a49e5'}}, 
    increasing: {line: {color: '#28C2ED'}},
    xaxis: 'x', 
    yaxis: 'y'
  }];
}

function maContext(ta, isExp) {
  var long = isExp ? ta.ema(21) : ta.sma(21);
  var short = isExp ? ta.ema(10) : ta.sma(10);

  var maLong = {
    name: isExp ? 'EMA(21)' : 'SMA(21)',
    x: ta.$time,
    y: long,
    type: 'line',
    line: {color: 'rgba(170, 120, 34, 0.7)'},
    visible: false
  }

  var maShort = {
    name: isExp ? 'EMA(10)' : 'SMA(10)',
    x: ta.$time,
    y: short,
    type: 'line',
    line: {color: 'rgba(20, 130, 40, 0.7)'},
    visible: false
  }

  return [maLong, maShort];
}

function bbContext(ta, isExp) {
  var bb = isExp ? ta.ebb() : ta.bb();
  var bbUpper = {
    showlegend: false,
    x: ta.$time,
    y: bb.upper,
    type: 'line',
    line: {color: 'rgba(188, 92, 242,0.7)'},
    visible: false
  }

  var bbMiddle = {
    name: isExp ? 'EMA(10)' : 'SMA(15)',
    x: ta.$time,
    y: bb.middle,
    type: 'line',
    line: {color: 'rgba(170, 120, 34, 0.7)'},
    visible: false
  }

  var bbLower = {
    name: isExp ? 'EBB(15,2)' : 'BB(15,2)',
    x: ta.$time,
    y: bb.lower,
    type: 'line',
    line: {color: 'rgba(63, 64, 208, 0.7)'},
    visible: false
  }

  return [bbUpper, bbLower, bbMiddle];
}

function macdContext(ta) {
  var bb = ta.macd();
  var bbUpper = {
    showlegend: false,
    x: ta.$time,
    y: bb.upper,
    type: 'line',
    line: {color: 'rgba(188, 92, 242,0.7)'},
    visible: false
  }

  var bbMiddle = {
    name: isExp ? 'EMA(10)' : 'SMA(15)',
    x: ta.$time,
    y: bb.middle,
    type: 'line',
    line: {color: 'rgba(170, 120, 34, 0.7)'},
    visible: false
  }

  var bbLower = {
    name: isExp ? 'EBB(15,2)' : 'BB(15,2)',
    x: ta.$time,
    y: bb.lower,
    type: 'line',
    line: {color: 'rgba(63, 64, 208, 0.7)'},
    visible: false
  }

  return [bbUpper, bbLower, bbMiddle];
}

</script>
</body>
</html>