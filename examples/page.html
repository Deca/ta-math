<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="../ta-math.js"></script>
    <script src="ccxt.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.min.css" type="text/css" />
    <link rel="stylesheet" href="page.css" type="text/css" />
</head>
<body>

<div id="loader"></div>
<div id="loader2">Waiting ohlcv data from server...</div>

<div id="chart" style="display:none;" class="animate-bottom" viewBox="25 25 50 50" >
    <svg ></svg>
</div>

<script>
(async function main () {
    function showChart() {
        document.getElementById("loader").style.display = "none";
        document.getElementById("loader2").style.display = "none";
        document.getElementById("chart").style.display = "block";
    }
    let ohlcv = await new ccxt.ccex({'proxy': 'https://cors-anywhere.herokuapp.com/'}).fetchOHLCV ('BTC/USDT', '1d', Date.now() - 1000*60*60*24*30*5);
    showChart();

    //------
    let ema = TA(ohlcv).ema(10);
    console.log(ema);
    //------

    let data = [{
        values: ohlcv.map( (x) => {return {"date" : x[0] / 1000 / 60 / 60 / 24, "open": x[1], "high": x[2], "low": x[3], "close": x[4], "volume": x[5]}})
    }];
    nv.addGraph(function() {
        var chart = nv.models.candlestickBarChart()
            .x(function(d) { return d['date'] })
            .y(function(d) { return d['close'] })
            .duration(250)
            .margin({left: 75, bottom: 50});
        chart.xAxis
                .axisLabel("Dates")
                .tickFormat(function(d) {
                    return d3.time.format('%x')(new Date(new Date() - (20000 * 86400000) + (d * 86400000)));
                });
        chart.yAxis
                .axisLabel('BTC Price')
                .tickFormat(function(d,i){ return '$' + d3.format(',.1f')(d); });
        d3.select("#chart svg")
                .datum(data)
                .transition().duration(500)
                .call(chart);
        nv.utils.windowResize(chart.update);
        return chart;
    });
})();
</script>
</body>
</html>